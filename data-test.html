<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
    <title>Geodata Test</title>
    <link rel="stylesheet" href="http://js.arcgis.com/3.13/esri/css/esri.css">
    <style>
        #mapDiv{
            height: 300px;
            width: 500px;
        }
    </style>
</head>
<body>
    <button onclick="stopAll()">Stop!</button>
    <button onclick="startGeo()">Start!</button>
    <button onclick="resert()">Reset!</button>
    <hr>
    <div id="mapDiv"></div>
    <hr>
    <div id="lat">0.0</div>
    <div id="lon">Lon: 0.0</div>
    <div id="accuracy">Accuracy: 0.0</div>
    <div id="heading">Heading: 0</div>
    <div id="altitude">Altitude: 0</div>
    <div id="speed">Speed: 0</div>
    <div id="timestamp">Timestamp: 0</div>
    <hr>
    <div id="time-diff">Time since last update: 0</div>
    <div id="strd-accuracy">Standard Deviation (accuracy): 0</div>
    <div id="avg-accuracy">Average (accuracy): 0</div>
    <div id="accuracy-array-count">Accuracy Array Length: 0</div>
    <hr>
    <div id="strd-lat-lon">Standard Deviation (lat, lon): 0, 0</div>
    <div id="avg-lat-lon">Average (lat, lon): 0, 0</div>
    <div id="lat-lon-array-count">Lat,Lon Array Length: 0, 0</div>

    <script src="http://js.arcgis.com/3.12/"></script>
    <script>

        //
        // EXPERIMENTAL!!
        //

        var _watchID = null;
        var accuracyArray = [];
        var latArray = [];
        var lonArray = [];
        var maxArraySize = 100;
        var lastUpdateDiffMillis = 0;
        var lastUpdateDateTime = 0;
        var timer = null;
        var map = null, _markerSymbol = null;

        // Algorithm
        var MAX_ACCURACY_ALLOWED = 100; // meters

        // Divs
        var strdAccuracyDiv = document.getElementById("strd-accuracy");
        var avgAccuracyDiv = document.getElementById("avg-accuracy");
        var accuracyDiv = document.getElementById("accuracy");
        var latDiv = document.getElementById("lat");
        var lonDiv = document.getElementById("lon");
        var altitudeDiv = document.getElementById("altitude");
        var speedDiv = document.getElementById("speed");
        var timestampDiv = document.getElementById("timestamp");
        var headingDiv = document.getElementById("heading");
        var timeDiffDiv = document.getElementById("time-diff");
        var accuracyArrCountDiv = document.getElementById("accuracy-array-count");
        var strdLatLonArrayDiv = document.getElementById("strd-lat-lon");
        var avgLatLonDiv = document.getElementById("avg-lat-lon");
        var latLonArrayCountDiv = document.getElementById("lat-lon-array-count");


        require([
            "esri/map",
            "esri/symbols/PictureMarkerSymbol",
            "esri/graphic",
            "esri/geometry/Point",
            "dojo/_base/Color",
            "dojo/domReady!"],
                function(Map,PictureMarkerSymbol,Graphic,Point,Color) {

                    map = new Map("mapDiv", {
                        basemap: "topo",
                        center: [-122.45, 37.75], // longitude, latitude
                        zoom: 13
                    });

                    // Create the marker symbol
                    _markerSymbol = new PictureMarkerSymbol({
                        "angle":0,
                        "xoffset":0,
                        "yoffset":16,
                        "type":"esriPMS",
                        "url":"images/green-pin.png",
                        "width":35,
                        "height":35
                    });
        });

        startGeo();

        function startGeo(){

            startTimer();

            _watchID = navigator.geolocation.watchPosition(
                    geoResults,
                    geoErrors,
                    {
                        timeout: 60000,
                        enableHighAccuracy: true,
                        maximumAge: 300000 //5 minutes
                    }
            );
        }

        function geoResults(position){

            restartTimer();

            var html5Lat = position.coords.latitude; //Get latitude
            var html5Lon = position.coords.longitude; //Get longitude
            var html5TimeStamp = position.timestamp; //Get timestamp
            var html5Accuracy = position.coords.accuracy; 	//Get accuracy in meters
            var html5Heading = position.coords.heading;
            var html5Speed = position.coords.speed;
            var html5Altitude = position.coords.altitude;

            if(html5Lat != null) latDiv.innerHTML = "Lat: " + html5Lat.toString();
            if(html5Lon != null) lonDiv.innerHTML = "Lon: " + html5Lon.toString();
            if(html5TimeStamp != null) timestampDiv.innerHTML = "Timestamp: " + html5TimeStamp.toString();
            if(html5Accuracy != null) accuracyDiv.innerHTML = "Accuracy (m): " + html5Accuracy.toString();
            if(html5Heading != null) headingDiv.innerHTML = "Heading: " + html5Heading.toString();
            if(html5Speed != null) speedDiv.innerHTML = "Speed (m/s): " + html5Speed.toString();
            if(html5Altitude != null) altitudeDiv.innerHTML = "Altitude: " + html5Altitude.toString();

            accuracyArrayHandler(html5Accuracy);
            latLonHandler(html5Lat,html5Lon);
            drawLocationMarker(html5Lat,html5Lon);
        }

        function drawLocationMarker(lat, lon){

            require([
                "esri/graphic",
                "esri/geometry/Point"],
                    function(Graphic,Point){
                        var geometry = new Point(lon,lat);

                        // Have to wait for map to initialize
                        if(map != null){
                            map.graphics.add(new Graphic(geometry, _markerSymbol));
                            map.centerAndZoom(geometry, 12);
                        }
                    }
            )
        }

        function startTimer(){
            var count = 0;
            timer = setInterval(function(){
                timeDiffDiv.innerHTML = "Time since last update (ms): " + count++;
            },1);
        }

        function restartTimer(){
            clearInterval(timer);
            startTimer();
        }

        function stopTimer(){
            clearInterval(timer);
        }

        function reset(){
            accuracyArray = [];
            latArray = [];
            lonArray = [];
            map.graphics.clear();
        }

        function accuracyArrayHandler(accuracy){
            if(accuracyArray.length > maxArraySize){
                accuracyArray.shift();
            }
            accuracyArray.push(accuracy);
            strdAccuracyDiv.innerHTML = "Standard Deviation (accuracy): " + standardDeviation(accuracyArray).toFixed(2).toString();
            avgAccuracyDiv.innerHTML = "Average (accuracy): " + average(accuracyArray).toFixed(2).toString();
            accuracyArrCountDiv.innerHTML = "Accuracy Array Count: " + accuracyArray.length.toString();
        }

        function latLonHandler(lat,lon){
            if(latArray.length > maxArraySize){
                latArray.shift();
            }
            if(lonArray.length > maxArraySize){
                lonArray.shift();
            }
            latArray.push(lat);
            lonArray.push(lon);
            strdLatLonArrayDiv.innerHTML = "Standard Deviation (lat, lon): " + standardDeviation(latArray).toFixed(2).toString() +
                ", " + standardDeviation(lonArray).toFixed(2).toString();
            avgLatLonDiv.innerHTML = "Average (lat, lon): " + average(latArray).toFixed(2).toString() +
                ", " + average(lonArray).toFixed(2).toString();
            latLonArrayCountDiv.innerHTML = "Lat, Lon Array Length: " + latArray.length.toString() +
                ", " + lonArray.length.toString();
        }

        function geoErrors(error){
            switch(error.code){
                // "PERMISSION_DENIED"
                case 1:

                    break;

                // "POSITION_UNAVAILABLE"
                case 2:

                    break;

                // "TIMEOUT"
                case 3:
                    //Read more at http://dev.w3.org/geo/api/spec-source.html#timeout

                    break;
            }
        }

        function stopAll(){
            stopTimer();
            navigator.geolocation.clearWatch(_watchID);
        }

        /**
         * standardDeviation() and average() functions courtesy of:
         * http://derickbailey.com/2014/09/21/calculating-standard-deviation-with-array-map-and-array-reduce-in-javascript/
         * @param values Array
         * @returns {number}
         */
        function standardDeviation(values){
            var avg = average(values);

            var squareDiffs = values.map(function(value){
                var diff = value - avg;
                var sqrDiff = diff * diff;
                return sqrDiff;
            });

            var avgSquareDiff = average(squareDiffs);

            var stdDev = Math.sqrt(avgSquareDiff);
            return stdDev;
        }

        function average(data){
            var sum = data.reduce(function(sum, value){
                return sum + value;
            }, 0);

            var avg = sum / data.length;
            return avg;
        }

    </script>
</body>
</html>