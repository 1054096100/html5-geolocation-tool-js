<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=9" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="format-detection" content="telephone=yes">
    <title>HTML 5 - Geolocation</title>
    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.3.1/jquery.mobile-1.3.1.min.css" />
    <link rel="stylesheet" href="http://serverapi.arcgisonline.com/jsapi/arcgis/3.3/js/dojo/dijit/themes/claro/claro.css">
    <link rel="stylesheet" href="http://serverapi.arcgisonline.com/jsapi/arcgis/3.3/js/esri/css/esri.css">
    <link rel="stylesheet" type="text/css" href="css/Geolocation.css" />
    <script type="text/javascript" src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
    <script src="http://code.jquery.com/mobile/1.3.1/jquery.mobile-1.3.1.min.js"></script>
    <script src="http://serverapi.arcgisonline.com/jsapi/arcgis/3.3compact/"></script>
    <script src="scripts/LocationHelper.js" type="text/javascript"></script>
</head>

<body>
<div data-role="page" id="home">

    <div data-theme="a" data-role="header" data-position="fixed">
        <h3>HTML5 Geolocation</h3>
        <a href="#" data-role="button" data-icon="grid" data-iconpos="notext" onclick="controller.showLocation();">Location</a>
        <a href="#settings" data-role="button" data-icon="gear" class="ui-btn-right" data-iconpos="notext">Settings</a>
    </div>

    <div id="div1">
        <table id="table1" border="1">
            <tr>
                <td>
                    <div id="altitude">Altitude: N/A</div>
                </td>
                <td colspan="2">
                    <div id="location">0.00, 0.00</div>
                </td>
            </tr>
            <tr>
                <td>
                    <div id="speed">Speed: N/A</div>
                </td>
                <td colspan="2">
                    <div id="timestamp">0:00:00</div>
                </td>
            </tr>
            <tr>
                <td>
                    <div id="heading">Heading: N/A</div>
                </td>
                <td>
                    <div id="accuracy">Accuracy: 0m</div>
                </td>
                <td>
                    <div id="geo-indicator">Geo: OFF</div>
                </td>
            </tr>

        </table>
    </div>

    <div data-role="content">
        <div id="map"></div>
    </div>

</div>

<div data-role="page" id="settings" data-add-back-btn="true">
    <div data-role="header">
        <h1>Settings</h1>
    </div>
    <div data-role="content">

        <div class="settings" style="margin-top: 15px;">
            <div>Geolocation:</div>
            <select name="slider" id="slider-geo-on-off" data-role="slider" data-theme="a">
                <option value="off">Off</option>
                <option value="on" selected>On</option>
            </select>
        </div>
        <div class="settings">
            <div>High Accuracy:</div>
            <select name="slider" id="slider-high-accuracy" data-role="slider" data-theme="a">
                <option value="off">Off</option>
                <option value="on" selected>On</option>
            </select>
        </div>
        <div class="settings">
            <div>Accumulate map points:</div>
            <select name="slider" id="slider-accumulate-pts" data-role="slider" data-theme="a">
                <option value="off">Off</option>
                <option value="on" selected>On</option>
            </select>
        </div>
        <div id="settings-border1">
            <div class="settings" style="width: 200px; margin-top: 10px;">
                <input type="checkbox" name="checkbox-0" id="checkbox-max-age" data-theme="b" data-mini="true" />
                <label for="checkbox-max-age">maximumAge = Infinity</label>
            </div>
            <div class="settings" style="width: 300px; margin-top: 10px;">
                <div id="label-geo-max-age">Geolocation maximumAge (ms x1000)</div>
                <input id="slider-max-age" data-type="range" name="slider-max-age"
                       value="15" min="0" max="60" data-theme="a" data-track-theme="b" />
            </div>
            <div class="settings" style="width: 300px;">
                <div id="label-geo-timeout">Geolocation timeout (ms x1000)</div>
                <input data-type="range" name="slider-4" id="slider-timeout"
                       value="15" min="0" max="60" data-theme="a" data-track-theme="b" />
            </div>
            <div class="settings">
                <div>maximumAge min/millis:</div>
                <select name="slider-min-milli" id="slider-min-milli" data-role="slider" data-theme="a">
                    <option value="millis" selected>millis</option>
                    <option value="mins">mins</option>
                </select>
            </div>
            <div class="settings">
                <div>timeout min/millis:</div>
                <select name="slider" id="slider-timeout-min-milli" data-role="slider" data-theme="a">
                    <option value="millis" selected>millis</option>
                    <option value="mins">mins</option>
                </select>
            </div>
        </div>
        <div id="emailDiv" class="settings" style="width: 200px; margin-top: 15px;">
            <button id="sendEmailButton" data-theme="b" onclick="controller.sendEmail()">Email CSV</button>
        </div>
    </div>
</div>


<script type="text/javascript">
    dojo.require("esri.map");

    $('document').ready(function(){
        $("#slider-geo-on-off").on("slidestop",controller.shutOffGeolocation);
        $("#slider-high-accuracy").on("slidestop",controller.toggleHighAccuracy);
        $("#slider-accumulate-pts").on("slidestop",controller.toggleAccumulate)
        $("#slider-min-milli").on("slidestop",controller.toggleMaxAge);
        $("#slider-timeout-min-milli").on("slidestop",controller.toggleTimeout);
        $("#slider-timeout").on("slidestop",controller.geoTimeoutChangeHandler);
        $("#slider-max-age").on("slidestop",controller.geoMaxAgeChangeHandler);
        $("#checkbox-max-age").bind("change",controller.checkboxMaxAgeHandler);
    })

    var controller = controller || {};

    /**
     * View Controller
     * @type {Object}
     */
    var controller = controller || {};

    controller.map = null;
    controller.helper = null;
    controller._MAIL_TO_ADDRESS = (function(){
        return "agup@esri.com";
    })();

    controller.init = (function() {

        controller.map = new esri.Map("map",{
            basemap:"topo",
            slider: false
        });

        dojo.connect(controller.map, "onLoad", function () {

            //Some browsers don't show full height after onLoad
            setTimeout(function(){
                controller.map.reposition();
                controller.map.resize();
            },450);

            //Don't start location service until after map loads
            controller.helper = new LocationHelper(controller.map);

            controller.helper.geoIndicatorDiv = $("#geo-indicator");
            controller.helper.locationDiv = document.getElementById("location");
            controller.helper.altitudeDiv = document.getElementById("altitude");
            controller.helper.speedDiv = document.getElementById("speed");
            controller.helper.headingDiv = document.getElementById("heading");
            controller.helper.timeStampDiv = document.getElementById("timestamp");
            controller.helper.accuracyDiv = document.getElementById("accuracy");

            controller.helper.startGeolocation();
        });
    });


    controller.restartGeo = (function restartGeo(){
        var test = confirm("Restart Geolocation?");
        if(test){
            controller.helper.startGeolocation();
        }
    });

    controller.toggleAccumulate = (function(evt){
        if(evt.target.id == "slider-accumulate-pts" && evt.target.value == "on"){
            controller.helper.accumulate = true;
        }
        else{
            controller.helper.accumulate = false;
        }
    });

    controller.checkboxMaxAgeHandler = (function(evt){

        setTimeout(function(){
            if(evt.target.id == "checkbox-max-age"){
                if($("checkbox-max-age").is(":checked")){
                    controller.helper.maximumAge = Infinity;
                }
                else{
                    var sliderMaxAge = $("#slider-max-age")[0].value;
                    var minMilli = $("#slider-min-milli").val();
                    if(minMilli == "millis"){
                        sliderMaxAge * 1000;
                    }
                    else{
                        sliderMaxAge * 60000;
                    }

                    controller.helper.maximumAge = sliderMaxAge;
                }

                controller.restartGeo();
            }
        },450);
    });

    controller.geoMaxAgeChangeHandler = (function(evt){

        if(evt.target.id == "slider-max-age")
        {
            controller.helper.maximumAge = evt.target.value;
            controller.restartGeo();
        }
    });

    controller.toggleMaxAge = (function(evt){
        var q = $("#slider-max-age");
        var sliderMaxAge = $("#slider-max-age")[0].value;

        if(evt.target.id == "slider-min-milli" && evt.target.value == "millis")
        {
            $("#label-geo-max-age").text("Geolocation maximumAge (x1000)");
            controller.helper.maximumAge = sliderMaxAge * 1000;
        }
        else if(evt.target.id == "slider-min-milli" && evt.target.value == "mins"){
            $("#label-geo-max-age").text("Geolocation maximumAge (mins)");
            controller.helper.maximumAge = sliderMaxAge * 60000;
        }

        controller.restartGeo();

    });


    controller.toggleTimeout = (function(evt){
        var sliderTimeout = $("#slider-timeout")[0].value;
        if(evt.target.id == "slider-timeout-min-milli" && evt.target.value == "millis")
        {
            $("#label-geo-timeout").text("Geolocation timeout (x1000)");
            controller.helper.timeout = sliderTimeout * 1000;
        }
        else if(evt.target.id == "slider-timeout-min-milli" && evt.target.value == "mins"){
            $("#label-geo-timeout").text("Geolocation timeout (mins)");
            controller.helper.timeout = sliderTimeout;
        }

        controller.restartGeo();
    });

    controller.geoTimeoutChangeHandler = (function(evt){

        if(evt.target.id == "slider-timeout")
        {
            this.helper.timeout = evt.target.value;

            controller.restartGeo();
        }
    });

    controller.showLocation = (function(){
        if($('#div1').is(':visible') == false || $('#div1').is(':hidden')){
            $('#div1').show();
        }
        else{
            $('#div1').hide();
        }

    });

    /**
     * Public function for shutting down the geolocation service.
     */
    controller.shutOffGeolocation = (function(){

        setTimeout(function(){
            if(controller.helper.getWatchId() != null){
                controller.helper.stopGeolocation();
                alert("Geolocation has been shutoff");
            }
            else{
                controller.helper.startGeolocation();
            }
        },250);
    });

    /**
     * Public function for toggling the geolocation high-accuracy property on/off
     */
    controller.toggleHighAccuracy = (function(){

        setTimeout(function (){
            if(controller.helper.getHighAccuracy() == true){
                controller.helper.setHighAccuracy(false);
            }
            else{
                controller.helper.setHighAccuracy(true);
            }
        },250);
    });

    /**
     * Public function for emailing a CSV file containing geolocation service information.
     */
   controller.sendEmail = (function(){
        window.open('mailto:'+ controller._MAIL_TO_ADDRESS +'?subject=HTML5 Accuracy Data&body=' +
                encodeURIComponent(controller.helper.getAccuracyCSV()));
    });

    dojo.ready(controller.init);
</script>
</body>
</html>